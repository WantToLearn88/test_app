package com.app.editor;

import android.app.AlertDialog;
import android.content.*;
import android.content.DialogInterface;
import android.content.Intent;
import android.content.res.*;
import android.graphics.Typeface;
import android.net.Uri;
import android.os.Bundle;
import android.view.Menu;
import android.view.MenuItem;
import android.widget.ArrayAdapter;
import android.widget.Button;
import android.widget.ListView;
import android.widget.Toast;
import androidx.annotation.NonNull;
import androidx.appcompat.app.AppCompatActivity;
import androidx.appcompat.widget.Toolbar;
import androidx.documentfile.provider.DocumentFile;
import io.github.rosemoe.sora.lang.EmptyLanguage;
import io.github.rosemoe.sora.langs.java.JavaLanguage;
import io.github.rosemoe.sora.widget.CodeEditor;
import io.github.rosemoe.sora.widget.schemes.EditorColorScheme;
import io.github.rosemoe.sora.widget.schemes.SchemeDarcula;
import io.github.rosemoe.sora.widget.schemes.SchemeEclipse;
import io.github.rosemoe.sora.widget.schemes.SchemeGitHub;
import io.github.rosemoe.sora.widget.schemes.SchemeNotepadXX;
import io.github.rosemoe.sora.widget.schemes.SchemeVS2019;
import java.io.BufferedReader;
import java.io.InputStreamReader;
import java.io.OutputStream;
import java.util.ArrayList;
import java.util.List;

public class MainActivity extends AppCompatActivity {

  private CodeEditor editor;
  private Toolbar _toolbar;

  private static final int REQUEST_OPEN = 1;
  private static final int REQUEST_SAVE = 2;

  private static final int REQUEST_OPEN_PROJECT = 100;
  private Uri projectRootUri;

  private ListView listFiles;
  private final List<DocumentFile> projectFiles = new ArrayList<>();

  @Override
  protected void onCreate(Bundle savedInstanceState) {
    super.onCreate(savedInstanceState);
    setContentView(R.layout.activity_main);

    editor = findViewById(R.id.editor);

    listFiles = findViewById(R.id.listFiles);

    // الإعدادات الافتراضية
    editor.setColorScheme(new SchemeDarcula());
    editor.setEditorLanguage(new JavaLanguage());
    editor.setTextSize(14f);
    editor.setLineNumberEnabled(true);

    Button btnOpen = findViewById(R.id.btnOpen);
    Button btnSave = findViewById(R.id.btnSave);
    Button btnOpenProject = findViewById(R.id.btnOpenProject);

    btnOpen.setOnClickListener(v -> openFile());
    btnSave.setOnClickListener(v -> saveFile());

    btnOpenProject.setOnClickListener(v -> openProject());
  }

  private void openFile() {
    Intent intent = new Intent(Intent.ACTION_OPEN_DOCUMENT);
    intent.addCategory(Intent.CATEGORY_OPENABLE);
    intent.setType("text/*");
    startActivityForResult(intent, REQUEST_OPEN);
  }

  private void saveFile() {
    Intent intent = new Intent(Intent.ACTION_CREATE_DOCUMENT);
    intent.addCategory(Intent.CATEGORY_OPENABLE);
    intent.setType("text/plain");
    intent.putExtra(Intent.EXTRA_TITLE, "code.txt");
    startActivityForResult(intent, REQUEST_SAVE);
  }

  private void openProject() {
    Intent intent = new Intent(Intent.ACTION_OPEN_DOCUMENT_TREE);
    intent.addFlags(
        Intent.FLAG_GRANT_READ_URI_PERMISSION
            | Intent.FLAG_GRANT_WRITE_URI_PERMISSION
            | Intent.FLAG_GRANT_PERSISTABLE_URI_PERMISSION);
    startActivityForResult(intent, REQUEST_OPEN_PROJECT);
  }

  // @Override
  // protected void onActivityResult(int requestCode, int resultCode, Intent data) {
  // super.onActivityResult(requestCode, resultCode, data);

  // if (resultCode != RESULT_OK || data == null) return;

  // Uri uri = data.getData();

  // try {
  // if (requestCode == REQUEST_OPEN) {
  // BufferedReader reader = new BufferedReader(
  // new InputStreamReader(getContentResolver().openInputStream(uri))
  // );

  // StringBuilder text = new StringBuilder();
  // String line;
  // while ((line = reader.readLine()) != null) {
  // text.append(line).append("\n");
  // }
  // reader.close();

  // editor.setText(text.toString());

  // } else if (requestCode == REQUEST_SAVE) {
  // OutputStream outputStream =
  // getContentResolver().openOutputStream(uri);

  // outputStream.write(editor.getText().toString().getBytes());
  // outputStream.close();
  // }

  // } catch (Exception e) {
  // e.printStackTrace();
  // }
  // }

  @Override
  protected void onActivityResult(int requestCode, int resultCode, Intent data) {
    super.onActivityResult(requestCode, resultCode, data);

    if (requestCode == REQUEST_OPEN_PROJECT) {

      if (resultCode != RESULT_OK || data == null) {
        showMessage("Project opening cancelled");
        return;
      }

      Uri uri = data.getData();
      if (uri == null) {
        showMessage("Invalid project folder");
        return;
      }

      // حفظ الصلاحيات
      final int flags =
          data.getFlags()
              & (Intent.FLAG_GRANT_READ_URI_PERMISSION | Intent.FLAG_GRANT_WRITE_URI_PERMISSION);

      try {
        getContentResolver().takePersistableUriPermission(uri, flags);
      } catch (SecurityException e) {
        showMessage("Permission denied for this folder");
        return;
      }

      projectRootUri = uri;
      showMessage("Project opened successfully");

      loadProjectFiles();
    }
  }

  private void loadProjectFiles() {

    projectFiles.clear();

    DocumentFile root = DocumentFile.fromTreeUri(this, projectRootUri);
    if (root == null || !root.isDirectory()) {
      showMessage("Invalid project directory");
      return;
    }

    readDirectoryRecursive(root);

    if (projectFiles.isEmpty()) {
      showMessage("No supported files found");
    }

    showFilesInList();
  }

  private void readDirectoryRecursive(DocumentFile dir) {

    for (DocumentFile file : dir.listFiles()) {

      if (file.isDirectory()) {
        readDirectoryRecursive(file);
        continue;
      }

      if (!file.isFile() || !file.canRead()) {
        continue;
      }

      String name = file.getName();
      if (name == null) continue;

      if (isSupportedFile(name)) {
        projectFiles.add(file);
      }
    }
  }

  private boolean isSupportedFile(String name) {
    String lower = name.toLowerCase();
    return lower.endsWith(".java")
        || lower.endsWith(".kt")
        || lower.endsWith(".xml")
        || lower.endsWith(".json")
        || lower.endsWith(".txt");
  }

  private void showFilesInList() {

    List<String> names = new ArrayList<>();

    for (DocumentFile file : projectFiles) {
      names.add(file.getName());
    }

    ArrayAdapter<String> adapter =
        new ArrayAdapter<>(this, android.R.layout.simple_list_item_1, names);

    listFiles.setAdapter(adapter);
  }

  private void showMessage(String msg) {
    Toast.makeText(this, msg, Toast.LENGTH_SHORT).show();
  }
}
